name: Auto PR Soft Skills

on:
  push:
    branches:
      - dev-main
    paths:
      - "soft-skills/20211124 Esquenta - Inteligência Emocional - Autoconhecimento - Emoções - Diário de Autoconhecimento.ods"

jobs:
  auto-pr:
    runs-on: ubuntu-latest

    env:
      BASE_BRANCH: main
      HEAD_BRANCH: dev-main
      PR_TITLE: Daily update

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate GitHub CLI authentication
        env:
          GH_TOKEN: ${{ secrets.PAT_GH_AUTOMERGE }}
        run: gh auth status

      - name: Create PR if it does not exist
        env:
          GH_TOKEN: ${{ secrets.PAT_GH_AUTOMERGE }}
        run: |
          PR_NUMBER=$(gh pr list \
            --base "$BASE_BRANCH" \
            --head "$HEAD_BRANCH" \
            --state open \
            --json number \
            --jq '.[0].number')

          if [ -z "$PR_NUMBER" ]; then
            echo "No open PR found. Creating PR..."
            gh pr create \
              --base "$BASE_BRANCH" \
              --head "$HEAD_BRANCH" \
              --title "$PR_TITLE" \
              --body ""
          else
            echo "PR already exists: #$PR_NUMBER"
          fi

      - name: Get PR number
        env:
          GH_TOKEN: ${{ secrets.PAT_GH_AUTOMERGE }}
        run: |
          PR_NUMBER=$(gh pr list \
            --base "$BASE_BRANCH" \
            --head "$HEAD_BRANCH" \
            --state open \
            --json number \
            --jq '.[0].number')

          echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_ENV
          echo "Using PR #$PR_NUMBER"

      - name: Approve PR (idempotent)
        env:
          GH_TOKEN: ${{ secrets.PAT_GH_AUTOMERGE }}
        run: |
          gh pr review "$PR_NUMBER" --approve || true

      - name: Enable auto-merge and merge PR
        env:
          GH_TOKEN: ${{ secrets.PAT_GH_AUTOMERGE }}
        run: |
          gh pr merge "$PR_NUMBER" \
            --merge \
            --auto \
            --delete-branch=false
